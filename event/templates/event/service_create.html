{% extends "event/base.html" %}

{% load static %}

{% block slider %}

{% endblock slider %}

{% block content %}
<section class="section-holder" style="margin-top: 120px;">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div id="contact-form-holder">
                    <form method="post" id="service-form" action="{% url 'service_create' business.business_slug %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="row margin-b24">
                            <!-- Basic Service Information -->
                            <div class="col-md-6 margin-bm24 mt-3"><input type="text" name="name" class="comm-field" placeholder="Service Name" required/></div>
                            <div class="col-md-12 margin-bm24 mt-3"><textarea name="description" class="comm-field" placeholder="Description" required></textarea></div>

                            <div class="col-md-12 margin-bm24 mt-3">
                                <input type="checkbox" name="available_by_quotation_only" id="available_by_quotation_only"/>
                                <label for="available_by_quotation_only">Available by Quotation Only</label>
                            </div>

                            <!-- Hire Details -->
                            <div class="col-md-6 margin-bm24 mt-3">
                                <input type="number" step="0.01" name="hire_price" class="comm-field" placeholder="Hire Price" id="hire_price"/>
                            </div>
                            <div class="col-md-6 margin-bm24 mt-3">
                                <select name="hire_duration" class="comm-field" id="hire_duration">
                                    <option value="" disabled selected>Hire Duration</option>
                                    <option value="hour">Hour</option>
                                    <option value="day">Day</option>
                                    <option value="week">Week</option>
                                </select>
                            </div>
                            
                            <!-- Setup/Packdown Fee -->
                            <div class="col-md-6 margin-bm24 mt-3">
                                <input type="checkbox" name="setup_packdown_fee" id="setup_packdown_fee_checkbox"/>
                                <label for="setup_packdown_fee_checkbox">Setup/Packdown Fee</label>
                            </div>
                            <div class="col-md-6 margin-bm24 mt-3">
                                <input type="number" step="0.01" name="setup_packdown_fee_amount" class="comm-field" placeholder="Setup/Packdown Fee Amount" id="setup_packdown_fee_amount" style="display: none;"/>
                            </div>
                            
                            <!-- Variations -->
                            <div class="col-md-12 margin-bm24 mt-3">
                                <input type="checkbox" name="has_variations" id="has_variations_checkbox" onchange="toggleServiceVariations()"/>
                                <label for="has_variations_checkbox">Has Variations</label>
                            </div>
                            <div id="service-variations-section" class="col-md-12 margin-bm24 mt-3" style="display: none;">
                                <div id="service_variation_fields" class="col-md-12 margin-bm24 mt-3"></div>
                                <button type="button" class="btn btn-secondary mt-3" onclick="addServiceVariation()">Add Another Variation</button>
                            </div>

                            <!-- Category and Images -->
                            <div class="col-md-6 margin-bm24 mt-3">
                                <label for="category">Category:</label>
                                <select name="category" id="category" class="comm-field">
                                    {% for category in categories %}
                                        <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 margin-bm24 mt-3">
                                <label for="category">Image*:</label>
                                <input type="file" name="images" class="comm-field" multiple required/>
                                <button type="button" class="btn btn-secondary mt-3" onclick="addImageField()">Add Another Image</button>
                            </div>
                        </div>
                        <p><input type="submit" value="Create Service" id="submit"/></p>
                    </form>
                </div>
                <!-- contact-form-holder-->
                <div id="output-contact"></div>
            </div>
            <!-- /col-lg-12 -->
        </div>
        <!-- /row -->
    </div>
    <!-- /container -->
</section>

<script>
    document.getElementById('setup_packdown_fee_checkbox').addEventListener('change', function() {
        var setupFeeField = document.getElementById('setup_packdown_fee_amount');
        setupFeeField.style.display = this.checked ? 'block' : 'none';
    });

    document.getElementById('available_by_quotation_only').addEventListener('change', function() {
        var hirePriceField = document.getElementById('hire_price');
        var hireDurationField = document.getElementById('hire_duration');
        var disable = this.checked;
        hirePriceField.disabled = disable;
        hireDurationField.disabled = disable;
    });

    let serviceVariationIndex = 0;

    function addServiceVariation() {
        let variationFields = document.getElementById('service_variation_fields');
        let newVariation = document.createElement('div');
        newVariation.className = 'variation-field mt-3';
        newVariation.innerHTML = `
            <div class="row mt-3">
                <div class="col-md-6">
                    <input type="text" name="variation_names_${serviceVariationIndex}" class="comm-field w-100" placeholder="Variation Name (e.g., Color, Size)" required>
                </div>
                <div class="col-md-6">
                    <button type="button" class="btn btn-secondary w-100" onclick="addServiceVariationValue(this, ${serviceVariationIndex})">Add Another Variation Value</button>
                </div>
            </div>
            <div class="variation-values" data-index="${serviceVariationIndex}"></div>
        `;
        variationFields.appendChild(newVariation);
        addServiceVariationValue(newVariation.querySelector('button'), serviceVariationIndex);
        serviceVariationIndex++;
    }

    function addServiceVariationValue(button, variationIndex) {
        let variationValues = button.closest('.variation-field').querySelector('.variation-values');
        let valueIndex = variationValues.children.length;
        let newValue = document.createElement('div');
        newValue.className = 'row mt-3';
        newValue.innerHTML = `
            <div class="col-md-3">
                <input type="text" name="variation_values_${variationIndex}[]" class="comm-field w-100" placeholder="Value (e.g., Red, Small)" required>
            </div>
            <div class="col-md-3">
                <div class="form-check mt-2">
                    <input type="checkbox" class="form-check-input" name="price_varies_${variationIndex}[]" onchange="togglePriceInput(this)">
                    <label class="form-check-label">Price Varies</label>
                </div>
            </div>
            <div class="col-md-3">
                <input type="number" step="0.01" name="variation_prices_${variationIndex}[]" class="comm-field w-100" placeholder="Price" style="display: none;">
                <small class="form-text text-muted">This price will be added to the main hire price.</small>
            </div>
            <div class="col-md-3">
                <button type="button" class="btn btn-danger w-100" onclick="removeVariationValue(this)">Remove</button>
            </div>
        `;
        variationValues.appendChild(newValue);
    }

    function togglePriceInput(checkbox) {
        let priceInput = checkbox.closest('.row').querySelector('input[name^="variation_prices"]');
        priceInput.style.display = checkbox.checked ? 'block' : 'none';
        priceInput.required = checkbox.checked;
    }

    function removeVariationValue(button) {
        let valueRow = button.closest('.row');
        valueRow.remove();
    }

    function toggleServiceVariations() {
        var variationsSection = document.getElementById('service-variations-section');
        variationsSection.style.display = variationsSection.style.display === 'none' ? 'block' : 'none';
        if (variationsSection.style.display === 'block' && document.getElementsByClassName('variation-field').length === 0) {
            addServiceVariation();
        }
    }

    function addImageField() {
        var imageFields = document.querySelector('input[name="images"]');
        var newField = imageFields.cloneNode();
        newField.value = ''; // Clear the value of the new field
        newField.className = 'comm-field mt-3'; // Add mt-3 class
        imageFields.parentNode.insertBefore(newField, imageFields.nextSibling);
    }
</script>

{% endblock content %}
