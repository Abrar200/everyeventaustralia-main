{% extends "event/base.html" %}

{% load static %}

{% block slider %}

{% endblock slider %}

{% block content %}
<!-- SECTION 1-->
<section class="section-holder" style="margin-top: 120px;">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div id="contact-form-holder">
                    <form method="post" id="service-form" action="{% url 'service_edit' business.business_slug service.service_slug %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="row margin-b24">
                            <!-- Basic Service Information -->
                            <div class="col-md-6 margin-bm24 mt-3">
                                <input type="text" name="name" class="comm-field" value="{{ service.name }}" required placeholder="Service Name"/>
                            </div>
                            <div class="col-md-12 margin-bm24 mt-3">
                                <textarea name="description" class="comm-field" required placeholder="Description">{{ service.description }}</textarea>
                            </div>

                            <!-- Hire Details -->
                            <div class="col-md-12 margin-bm24 mt-3">
                                <input type="checkbox" name="available_by_quotation_only" id="available_by_quotation_only" {% if service.available_by_quotation_only %}checked{% endif %}>
                                <label for="available_by_quotation_only">Available by Quotation Only</label>
                            </div>
                            <div class="col-md-6 margin-bm24 mt-3">
                                <input type="number" step="0.01" name="hire_price" class="comm-field" value="{{ service.hire_price }}" placeholder="Hire Price" id="hire_price" {% if service.available_by_quotation_only %}disabled{% endif %}/>
                            </div>
                            <div class="col-md-6 margin-bm24 mt-3">
                                <select name="hire_duration" class="comm-field" id="hire_duration" {% if service.available_by_quotation_only %}disabled{% endif %}>
                                    <option value="" disabled {% if not service.hire_duration %}selected{% endif %}>Hire Duration</option>
                                    <option value="hour" {% if service.hire_duration == 'hour' %}selected{% endif %}>Hour</option>
                                    <option value="day" {% if service.hire_duration == 'day' %}selected{% endif %}>Day</option>
                                    <option value="week" {% if service.hire_duration == 'week' %}selected{% endif %}>Week</option>
                                </select>
                            </div>
                            
                            <!-- Setup/Packdown Fee -->
                            <div class="col-md-12 margin-bm24 mt-3">
                                <input type="checkbox" name="setup_packdown_fee" id="setup_packdown_fee_checkbox" {% if service.setup_packdown_fee %}checked{% endif %}>
                                <label for="setup_packdown_fee_checkbox">Setup/Packdown Fee</label>
                            </div>
                            <div class="col-md-6 margin-bm24 mt-3">
                                <input type="number" step="0.01" name="setup_packdown_fee_amount" class="comm-field" value="{{ service.setup_packdown_fee_amount }}" placeholder="Setup/Packdown Fee Amount" id="setup_packdown_fee_amount" style="display: {% if service.setup_packdown_fee %}block{% else %}none{% endif %};"/>
                            </div>

                            <!-- Variations -->
                            <div class="col-md-12 margin-bm24 mt-3">
                                <input type="checkbox" name="has_variations" id="has_variations_checkbox" {% if service.has_variations %}checked{% endif %} onchange="toggleServiceVariations()">
                                <label for="has_variations_checkbox">Has Variations</label>
                            </div>
                            <div id="service-variations-section" class="col-md-12 margin-bm24 mt-3" style="display: {% if service.has_variations %}block{% else %}none{% endif %};">
                                <div id="service_variation_fields" class="col-md-12 margin-bm24 mt-3">
                                    {% for variation_name, values in service_variations_with_values.items %}
                                        <div class="variation-field mt-3">
                                            <div class="row mt-3">
                                                <div class="col-md-6">
                                                    <input type="text" name="variation_names_{{ forloop.counter0 }}" class="comm-field w-100" value="{{ variation_name }}" required placeholder="Variation Name (e.g., Color, Size)">
                                                </div>
                                                <div class="col-md-6">
                                                    <button type="button" class="btn btn-secondary w-100" onclick="addServiceVariationValue(this, {{ forloop.counter0 }})">Add Another Variation Value</button>
                                                </div>
                                            </div>
                                            <div class="variation-values" data-index="{{ forloop.counter0 }}">
                                                {% for value in values %}
                                                    <div class="row mt-3">
                                                        <input type="hidden" name="variation_value_ids_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" value="{{ value.id }}">
                                                        <div class="col-md-3">
                                                            <input type="text" name="variation_values_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" class="comm-field w-100" value="{{ value.value }}" required placeholder="Value (e.g., Red, Small)">
                                                        </div>
                                                        <div class="col-md-3">
                                                            <div class="form-check mt-2">
                                                                <input type="checkbox" class="form-check-input" name="price_varies_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" onchange="togglePriceInput(this)" {% if value.price_varies %}checked{% endif %}>
                                                                <label class="form-check-label">Price Varies</label>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <input type="number" step="0.01" name="variation_prices_{{ forloop.parentloop.counter0 }}_{{ forloop.counter0 }}" class="comm-field w-100" value="{{ value.price }}" placeholder="Price" style="display: {% if value.price %}block{% else %}none{% endif %};" {% if value.price %}required{% endif %}>
                                                            <small class="form-text text-muted">This price will be added to the main hire price.</small>
                                                        </div>
                                                        <div class="col-md-3">
                                                            <button type="button" class="btn btn-danger w-100" onclick="removeVariationValue(this)">Remove</button>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <button type="button" class="btn btn-secondary mt-3" onclick="addServiceVariation()">Add Another Variation</button>
                            </div>

                            <!-- Category and Images -->
                            <div class="col-md-6 margin-bm24 mt-3">
                                <label for="category">Category:</label>
                                <select name="category" id="category" class="comm-field">
                                    {% for category in categories %}
                                        <option value="{{ category.id }}" {% if category == service.category %}selected{% endif %}>{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-12 margin-bm24 mt-3">
                                <h4>Current Images:</h4>
                                <div class="image-gallery">
                                    {% for image in service.images.all %}
                                        <div class="image-container">
                                            <img src="{{ image.image.url }}" alt="Service Image">
                                            <span class="delete-image" onclick="deleteImage({{ image.id }}, this)">&times;</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="col-md-6 margin-bm24 mt-3">
                                <input type="file" name="images" class="comm-field" multiple/>
                                <button type="button" class="btn btn-secondary mt-3" onclick="addImageField()">Add Another Image</button>
                            </div>
                        </div>
                        <p><input type="submit" value="Update Service" id="submit"/></p>
                    </form>
                </div>
                <!-- contact-form-holder-->
                <div id="output-contact"></div>
            </div>
            <!-- /col-lg-12 -->
        </div>
        <!-- /row -->
    </div>
    <!-- /container -->
</section>
<!-- /SECTION 1-->

<style>
    .image-gallery {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    .image-container {
        position: relative;
        width: 100px;
        height: 100px;
    }
    .image-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .delete-image {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: rgba(255, 255, 255, 0.7);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s;
    }
    .image-container:hover .delete-image {
        opacity: 1;
    }
</style>

<script>
    document.getElementById('setup_packdown_fee_checkbox').addEventListener('change', function() {
        var setupFeeField = document.getElementById('setup_packdown_fee_amount');
        setupFeeField.style.display = this.checked ? 'block' : 'none';
    });

    document.getElementById('available_by_quotation_only').addEventListener('change', function() {
        var hirePriceField = document.getElementById('hire_price');
        var hireDurationField = document.getElementById('hire_duration');
        var disable = this.checked;
        hirePriceField.disabled = disable;
        hireDurationField.disabled = disable;
    });

    function addImageField() {
        var imageFields = document.querySelector('input[name="images"]');
        var newField = imageFields.cloneNode();
        newField.value = ''; // Clear the value of the new field
        newField.className = 'comm-field mt-3'; // Add mt-3 class
        imageFields.parentNode.insertBefore(newField, imageFields.nextSibling);
    }

    function deleteImage(imageId, element) {
        if (confirm('Are you sure you want to delete this image?')) {
            fetch(`/delete-service-image/${imageId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    element.closest('.image-container').remove();
                } else {
                    alert('Failed to delete image');
                }
            });
        }
    }

    let serviceVariationIndex = {{ service_variations_with_values|length }};

    function toggleServiceVariations() {
        var variationsSection = document.getElementById('service-variations-section');
        variationsSection.style.display = variationsSection.style.display === 'none' ? 'block' : 'none';
        if (variationsSection.style.display === 'block' && document.getElementsByClassName('variation-field').length === 0) {
            addServiceVariation();
        }
    }

    function addServiceVariation() {
        let variationFields = document.getElementById('service_variation_fields');
        let newVariation = document.createElement('div');
        newVariation.className = 'variation-field mt-3';
        newVariation.innerHTML = `
            <div class="row mt-3">
                <div class="col-md-6">
                    <input type="text" name="variation_names_${serviceVariationIndex}" class="comm-field w-100" placeholder="Variation Name (e.g., Color, Size)" required>
                </div>
                <div class="col-md-6">
                    <button type="button" class="btn btn-secondary w-100" onclick="addServiceVariationValue(this, ${serviceVariationIndex})">Add Another Variation Value</button>
                </div>
            </div>
            <div class="variation-values" data-index="${serviceVariationIndex}"></div>
        `;
        variationFields.appendChild(newVariation);
        addServiceVariationValue(newVariation.querySelector('button'), serviceVariationIndex);
        serviceVariationIndex++;
    }

    function addServiceVariationValue(button, variationIndex) {
        let variationValues = button.closest('.variation-field').querySelector('.variation-values');
        let valueIndex = variationValues.children.length;
        let newValue = document.createElement('div');
        newValue.className = 'row mt-3';
        newValue.innerHTML = `
            <input type="hidden" name="variation_value_ids_${variationIndex}_${valueIndex}" value="">
            <div class="col-md-3">
                <input type="text" name="variation_values_${variationIndex}_${valueIndex}" class="comm-field w-100" placeholder="Value (e.g., Red, Small)" required>
            </div>
            <div class="col-md-3">
                <div class="form-check mt-2">
                    <input type="checkbox" class="form-check-input" name="price_varies_${variationIndex}_${valueIndex}" onchange="togglePriceInput(this)">
                    <label class="form-check-label">Price Varies</label>
                </div>
            </div>
            <div class="col-md-3">
                <input type="number" step="0.01" name="variation_prices_${variationIndex}_${valueIndex}" class="comm-field w-100" placeholder="Price" style="display: none;">
                <small class="form-text text-muted">This price will be added to the main hire price.</small>
            </div>
            <div class="col-md-3">
                <button type="button" class="btn btn-danger w-100" onclick="removeVariationValue(this)">Remove</button>
            </div>
        `;
        variationValues.appendChild(newValue);
    }

    function togglePriceInput(checkbox) {
        let priceInput = checkbox.closest('.row').querySelector('input[name^="variation_prices"]');
        priceInput.style.display = checkbox.checked ? 'block' : 'none';
        priceInput.required = checkbox.checked;
    }

    function removeVariationValue(button) {
        let valueRow = button.closest('.row');
        valueRow.remove();
    }
</script>

{% endblock content %}
