{% extends "event/base.html" %}
{% load static %}

{% block slider %}
{% endblock slider %}

{% block content %}
<section class="section-holder" style="margin-top: 120px;">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div id="contact-form-holder">
                    <form method="post" id="contact-form" action="{% url 'business_registration' %}" enctype="multipart/form-data" onsubmit="return validateOpeningHours();">
                        {% csrf_token %}

                        <!-- Introductory Section -->
                        <div class="form-section text-center" data-section="0">
                            <h2 class="mb-4">Create your vendor storefront</h2>
                            <p class="mb-5"><em>(Available to Adelaide and Melbourne Vendors only at this time)</em></p>

                            <div class="text-left mx-auto" style="max-width: 600px;">
                                <h5>HOW IT WORKS</h5>
                                <ul class="list-unstyled">
                                    <li>✓ Create your free account</li>
                                    <li>✓ Setup your e-commerce storefront</li>
                                    <li>✓ Enhance your online presence</li>
                                    <li>✓ Make sales directly with your target audience</li>
                                    <li>✓ Benefit from automatic customer payments paid on time</li>
                                    <li>✓ Fully manageable dashboard for order and storefront management</li>
                                    <li>✓ Receive assistance with sales and customer service operations</li>
                                    <li>✓ Receive complimentary advertising and marketing of your product offerings</li>
                                    <li>✓ Join and be listed alongside reputable event vendors</li>
                                    <li>✓ Chance to contribute to blog features</li>
                                </ul>

                                <h5 class="mt-5">VENDOR DASHBOARD AND PROFILE</h5>
                                <ul>
                                    <li>Have full control over your vendor dashboard and online profile.</li>
                                    <li>Manage your product and services listings, business details and terms and conditions.</li>
                                    <li>Setup your customer payment schedule however you like.</li>
                                    <li>Manage your upcoming and past orders.</li>
                                    <li>Respond to order requests and communicate with customers via our chat system.</li>
                                </ul>

                                <h5 class="mt-5">FEES</h5>
                                <p>We withhold a 14% service fee from all sales however we do not charge subscription or listing fees for vendors, therefore having a vendor account with us is completely risk free!</p>

                                <h5 class="mt-5">MAKE SALES DIRECTLY WITH CUSTOMERS</h5>
                                <p>We are a transactional platform for our suppliers, not a directory, meaning our customers can view, select and add to cart your products and services. You will receive notification of the customer's order for you to respond to.</p>

                                <h5 class="mt-5">AUTOMATIC PAYMENTS</h5>
                                <p>We use a third party payment system (Stripe) that guarantees you will ALWAYS be paid without chasing up clients. You will be able to setup your payment terms in your dashboard however you like.</p>

                                <h5 class="mt-5">COMPLIMENTARY ADVERTISING AND MARKETING</h5>
                                <p style="margin-bottom: 20px;">We use a number of advertising and marketing techniques that put your vendor profile and listings in direct contact with your target demographic.</p>
                            </div>
                            <button type="button" style="background-color: #710919; color: #FFFFFF; border: none; padding: 12px 24px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease;" onclick="nextSection(0)">Create your storefront</button>
                        </div>
                        
                        <!-- Section 1: Personal Information -->
                        <div class="form-section" data-section="1" style="display: none;">
                            <h3>Personal Information</h3>
                            <div class="row margin-b24">
                                <div class="col-md-6 margin-bm24">
                                    <input type="text" name="first_name" class="comm-field" placeholder="First Name" required/>
                                </div>
                                <div class="col-md-6 margin-bm24">
                                    <input type="text" name="last_name" class="comm-field" placeholder="Last Name" required/>
                                </div>
                                <div class="col-md-12 margin-bm24 mt-3">
                                    <input type="email" name="email" class="comm-field" placeholder="Email" required/>
                                </div>
                                <div class="col-md-6 margin-bm24 mt-3">
                                    <input type="password" name="password" class="comm-field" placeholder="Password" required/>
                                </div>
                                <div class="col-md-6 margin-bm24 mt-3">
                                    <input type="password" name="confirm_password" class="comm-field" placeholder="Confirm Password" required/>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button type="button" style="background-color: #707070; color: #FFFFFF; border: none; padding: 12px 24px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease;" onclick="prevSection(1)">Back</button>
                                <button type="button" style="background-color: #710919; color: #FFFFFF; border: none; padding: 12px 24px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease;" onclick="nextSection(1)">Next</button>
                            </div>
                        </div>
                        
                        <!-- Section 2: Business Information -->
                        <div class="form-section" data-section="2" style="display: none;">
                            <h3>Business Information</h3>
                            <div class="row margin-b24">
                                <div class="col-md-6 margin-bm24">
                                    <input type="text" name="business_name" class="comm-field" placeholder="Business Name" required/>
                                </div>
                                <div class="col-md-6 margin-bm24">
                                    <textarea name="description" class="comm-field" placeholder="Description" required></textarea>
                                </div>
                                <div class="col-md-6 margin-bm24 mt-3">
                                    <input type="text" id="address-input" name="address" class="comm-field" placeholder="Start typing your address" required/>
                                    <input type="hidden" id="latitude" name="latitude">
                                    <input type="hidden" id="longitude" name="longitude">
                                </div>
                                <div class="col-md-6 margin-bm24 mt-3">
                                    <input type="tel" name="phone" class="comm-field" placeholder="Phone" required/>
                                </div>
                                <div class="col-md-6 margin-bm24 mt-3">
                                    <label for="profile_picture">Profile Picture:</label>
                                    <input type="file" name="profile_picture" id="profile_picture" class="comm-field"/>
                                </div>
                                <div class="col-md-6 margin-bm24 mt-3">
                                    <label for="banner_image">Banner Image:</label>
                                    <input type="file" name="banner_image" id="banner_image" class="comm-field"/>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button type="button" style="background-color: #707070; color: #FFFFFF; border: none; padding: 12px 24px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease;" onclick="prevSection(2)">Back</button>
                                <button type="button" style="background-color: #710919; color: #FFFFFF; border: none; padding: 12px 24px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease;" onclick="nextSection(2)">Next</button>
                            </div>
                        </div>
                        
                        <!-- Section 3: Location and Contact Information -->
                        <div class="form-section" data-section="3" style="display: none;">
                            <h3>Location and Contact Information</h3>
                            <div class="row margin-b24">
                                <div class="col-md-6 margin-bm24">
                                    <label>States:</label><br>
                                    {% for state in states %}
                                        <input type="checkbox" name="states" value="{{ state.id }}" id="state_{{ state.id }}">
                                        <label for="state_{{ state.id }}">{{ state.name }}</label><br>
                                    {% endfor %}
                                </div>
                                <div class="col-md-12 margin-bm24 mt-3">
                                    <h3>Events You Cater</h3>
                                    {% for category in event_categories %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="event_categories" value="{{ category.id }}" id="category_{{ category.id }}">
                                            <label class="form-check-label" for="category_{{ category.id }}">
                                                {{ category.name }}
                                            </label>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button type="button" style="background-color: #707070; color: #FFFFFF; border: none; padding: 12px 24px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease;" onclick="prevSection(3)">Back</button>
                                <button type="button" style="background-color: #710919; color: #FFFFFF; border: none; padding: 12px 24px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease;" onclick="nextSection(3)">Next</button>
                            </div>
                        </div>

                        <!-- Section 4: Terms and Conditions -->
                        <div class="form-section" data-section="4" style="display: none;">
                            <h3>Terms and Conditions</h3>
                            <div class="row margin-b24">
                                <div class="col-md-12 margin-bm24 mt-3">
                                    <textarea name="terms_and_conditions" class="comm-field" placeholder="Enter your business terms and conditions"></textarea>
                                    <div style="text-align: center; margin: 10px 0;">OR</div>
                                    <input type="file" name="terms_and_conditions_pdf" class="comm-field" accept="application/pdf">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button type="button" style="background-color: #707070; color: #FFFFFF; border: none; padding: 12px 24px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease;" onclick="prevSection(4)">Back</button>
                                <button type="button" style="background-color: #710919; color: #FFFFFF; border: none; padding: 12px 24px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease;" onclick="nextSection(4)">Next</button>
                            </div>
                        </div>

                        <!-- Section 5: Delivery and Awards -->
                        <div class="form-section" data-section="5" style="display: none;">
                            <h3>Delivery and Awards</h3>
                            
                            <!-- Delivery Type Selection -->
                            <div class="row margin-b24">
                                <div class="col-md-12 margin-bm24 mt-3">
                                    <label for="delivery_type">Select Delivery Type:</label><br>
                                    <input type="radio" name="delivery_type" value="price_per_way" id="delivery_price_per_way" onclick="toggleDeliveryFields('price_per_way')">
                                    <label for="delivery_price_per_way">Delivery Price Per Way</label><br>
                                    <input type="radio" name="delivery_type" value="by_radius" id="delivery_by_radius" onclick="toggleDeliveryFields('by_radius')">
                                    <label for="delivery_by_radius">Delivery By Radius</label>
                                </div>
                            </div>
                            
                            <!-- Delivery Price Per Way Fields -->
                            <div id="delivery_price_per_way_fields" style="display: none;">
                                <div class="row margin-b24">
                                    <div class="col-md-12 margin-bm24 mt-3">
                                        <label for="max_delivery_distance">Maximum Delivery Distance (km):</label>
                                        <input type="number" name="max_delivery_distance" id="max_delivery_distance" class="comm-field" min="1" placeholder="Enter maximum delivery distance in kilometers">
                                        <small class="form-text text-muted">Specify the maximum distance you are willing to deliver.</small>
                                    </div>
                                    <div class="col-md-12 margin-bm24 mt-3">
                                        <label for="delivery_price_per_way">Price Per Way (A$):</label>
                                        <input type="number" name="delivery_price_per_way" id="delivery_price_per_way" class="comm-field" min="0" placeholder="Enter delivery fee per way">
                                        <small class="form-text text-muted">Enter the delivery fee per way. The total delivery fee will be twice this amount for a round trip.</small>
                                    </div>
                                </div>
                            </div>
                            
                            
                            <!-- Delivery By Radius Fields -->
                            <div id="delivery_by_radius_fields" style="display: none;">
                                <div id="radius-fields-container">
                                    <div class="row margin-b24 mt-3" id="radius-field-template">
                                        <div class="col-md-6 margin-bm24">
                                            <label for="delivery_radius">Delivery Radius (km):</label>
                                            <input type="number" name="delivery_radius" class="comm-field" min="1" placeholder="Enter delivery radius in kilometers">
                                        </div>
                                        <div class="col-md-6 margin-bm24">
                                            <label for="delivery_radius_price">Price (A$):</label>
                                            <input type="number" name="delivery_radius_price" class="comm-field" min="0" placeholder="Enter delivery fee for this radius">
                                        </div>
                                    </div>
                                </div>
                                <button type="button" onclick="addRadiusField()" class="btn btn-secondary mt-3">Add More</button>
                            </div>
                            
                            <!-- Awards Section -->
                            <div class="row margin-b24 mt-3">
                                <div class="col-md-12 margin-bm24 mt-3">
                                    <h3>Awards</h3>
                                    <div id="awards-container">
                                        <input type="file" name="awards" class="comm-field">
                                    </div>
                                    <button type="button" onclick="addAwardField()" class="btn btn-secondary mt-3">Add Another Award</button>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" style="background-color: #707070; color: #FFFFFF; border: none; padding: 12px 24px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease;" onclick="prevSection(5)">Back</button>
                                <button type="button" style="background-color: #710919; color: #FFFFFF; border: none; padding: 12px 24px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease;" onclick="nextSection(5)">Next</button>
                            </div>
                        </div>

                        <script>
                            function toggleDeliveryFields(selectedType) {
                                document.getElementById('delivery_price_per_way_fields').style.display = selectedType === 'price_per_way' ? 'block' : 'none';
                                document.getElementById('delivery_by_radius_fields').style.display = selectedType === 'by_radius' ? 'block' : 'none';
                            }

                            function addRadiusField() {
                                const container = document.getElementById('radius-fields-container');
                                const newField = document.createElement('div');
                                newField.className = 'row margin-b24 mt-3';
                                newField.innerHTML = `
                                    <div class="col-md-6 margin-bm24">
                                        <label for="delivery_radius">Delivery Radius (km):</label>
                                        <input type="number" name="delivery_radius" class="comm-field" min="1" placeholder="Enter delivery radius in kilometers">
                                    </div>
                                    <div class="col-md-6 margin-bm24">
                                        <label for="delivery_radius_price">Price (A$):</label>
                                        <input type="number" name="delivery_radius_price" class="comm-field" min="0" placeholder="Enter delivery fee for this radius">
                                        <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeRadiusField(this)">Remove</button>
                                    </div>`;
                                container.appendChild(newField);
                            }


                            function removeRadiusField(button) {
                                const field = button.closest('.row');
                                field.remove();
                            }

                            function addAwardField() {
                                const container = document.getElementById('awards-container');
                                const input = document.createElement('input');
                                input.type = 'file';
                                input.name = 'awards';
                                input.className = 'comm-field';
                                container.appendChild(input);
                            }
                        </script>

                        <!-- Section 6: Opening Hours -->
                        <div class="form-section" data-section="6" style="display: none;">
                            <h3>Opening Hours</h3>
                            {% for day, day_display in day_choices %}
                                <div class="row mt-3">
                                    <div class="col-md-2">
                                        <label for="opening_hours-{{ day }}">{{ day_display }}:</label>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="time" name="opening_hours-{{ day }}-opening_time" id="opening_hours-{{ day }}-opening_time" class="comm-field opening-time">
                                        <label for="opening_hours-{{ day }}-opening_time">Opening Time</label>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="time" name="opening_hours-{{ day }}-closing_time" id="opening_hours-{{ day }}-closing_time" class="comm-field closing-time">
                                        <label for="opening_hours-{{ day }}-closing_time">Closing Time</label>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="checkbox" name="opening_hours-{{ day }}-is_closed" id="opening_hours-{{ day }}-is_closed" class="is-closed" onchange="toggleOpeningClosingFields('{{ day }}')">
                                        <label for="opening_hours-{{ day }}-is_closed">Closed</label>
                                    </div>
                                </div>
                            {% endfor %}
                            <div class="form-check mt-4">
                                <input type="checkbox" name="agree_terms" id="agree_terms" class="form-check-input" required>
                                <label for="agree_terms" class="form-check-label">I agree to the <a href="{% url 'terms_and_conditions' %}" target="_blank">terms and conditions</a></label>
                            </div>
                            <p class="mt-3">
                                After clicking "Register Business", you will be redirected to Stripe for account integration. Please complete this process in one session to finalize your registration.
                            </p>
                            <p><input type="submit" value="Register Business" id="submit" class="btn btn-primary mt-3" onclick="return validateOpeningHours();"/></p>
                        </div>
                    </form>
                </div>
                <!-- contact-form-holder-->
                <div id="output-contact"></div>
            </div>
            <!-- /col-lg-12 -->
        </div>
        <!-- /row -->
    </div>
    <!-- /container -->
</section>

<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initAutocomplete" async defer></script>
<script>
    function initAutocomplete() {
        var input = document.getElementById('address-input');
        var autocomplete = new google.maps.places.Autocomplete(input, {
            types: ['address'],
            componentRestrictions: { country: 'au' }
        });

        autocomplete.addListener('place_changed', function() {
            var place = autocomplete.getPlace();
            if (!place.geometry) {
                window.alert("No details available for input: '" + place.name + "'");
                return;
            }

            document.getElementById('latitude').value = place.geometry.location.lat();
            document.getElementById('longitude').value = place.geometry.location.lng();
        });
    }

    
    function nextSection(currentSection) {
        const currentFormSection = document.querySelector(`.form-section[data-section="${currentSection}"]`);
        const nextFormSection = document.querySelector(`.form-section[data-section="${currentSection + 1}"]`);

        if (validateSection(currentFormSection)) {
            currentFormSection.style.display = 'none';
            if (nextFormSection) {
                nextFormSection.style.display = 'block';
            }
        } else {
            alert('Please fill out all required fields.');
        }
    }

    function prevSection(currentSection) {
        const currentFormSection = document.querySelector(`.form-section[data-section="${currentSection}"]`);
        const prevFormSection = document.querySelector(`.form-section[data-section="${currentSection - 1}"]`);

        currentFormSection.style.display = 'none';
        if (prevFormSection) {
            prevFormSection.style.display = 'block';
        }
    }

    function validateSection(section) {
        let isValid = true;
        const requiredInputs = section.querySelectorAll('[required]');

        requiredInputs.forEach(input => {
            if (!input.value) {
                isValid = false;
            }
        });

        // Additional checks for specific fields
        if (section.querySelector('[name="states"]')) {
            const statesChecked = section.querySelectorAll('[name="states"]:checked').length > 0;
            if (!statesChecked) isValid = false;
        }

        if (section.querySelector('[name="event_categories"]')) {
            const eventCategoriesChecked = section.querySelectorAll('[name="event_categories"]:checked').length > 0;
            if (!eventCategoriesChecked) isValid = false;
        }

        const terms = section.querySelector('[name="terms_and_conditions"]');
        const termsPdf = section.querySelector('[name="terms_and_conditions_pdf"]');
        if (terms && termsPdf && !terms.value && !termsPdf.value) {
            isValid = false;
        }

        return isValid;
    }

    function addAwardField() {
        const container = document.getElementById('awards-container');
        const newField = document.createElement('div');
        newField.className = 'award-field-template';
        newField.innerHTML = `
            <input type="file" name="awards" class="comm-field">
            <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeAwardField(this)">Remove</button>`;
        container.appendChild(newField);
    }

    function removeAwardField(button) {
        const field = button.closest('.award-field-template');
        field.remove();
    }

    
    function validateOpeningHours() {
        const rows = document.querySelectorAll('.row.mt-3');
        let isValid = true;
        let invalidDays = [];
    
        rows.forEach(row => {
            const day = row.querySelector('label').textContent.trim().slice(0, -1);
            const openingTime = row.querySelector('.opening-time').value;
            const closingTime = row.querySelector('.closing-time').value;
            const isClosed = row.querySelector('.is-closed').checked;
    
            if (!isClosed && (!openingTime || !closingTime)) {
                isValid = false;
                invalidDays.push(day);
            }
        });
    
        if (!isValid) {
            alert(`Please ensure that for the following days, either both opening and closing times are set, or the "Closed" checkbox is checked: ${invalidDays.join(', ')}`);
            return false;
        }
    
        return true;
    }

    function toggleOpeningClosingFields(day) {
        const openingTimeField = document.getElementById(`opening_hours-${day}-opening_time`);
        const closingTimeField = document.getElementById(`opening_hours-${day}-closing_time`);
        const isClosedCheckbox = document.getElementById(`opening_hours-${day}-is_closed`);

        // Disable or enable the opening/closing time fields based on the "Closed" checkbox
        if (isClosedCheckbox.checked) {
            openingTimeField.value = '';
            closingTimeField.value = '';
            openingTimeField.disabled = true;
            closingTimeField.disabled = true;
        } else {
            openingTimeField.disabled = false;
            closingTimeField.disabled = false;
        }
    }

    function toggleOpeningClosingFields(day) {
        const openingTimeField = document.getElementById(`opening_hours-${day}-opening_time`);
        const closingTimeField = document.getElementById(`opening_hours-${day}-closing_time`);
        const isClosedCheckbox = document.getElementById(`opening_hours-${day}-is_closed`);

        if (isClosedCheckbox.checked) {
            openingTimeField.value = '';
            closingTimeField.value = '';
            openingTimeField.disabled = true;
            closingTimeField.disabled = true;
        } else {
            openingTimeField.disabled = false;
            closingTimeField.disabled = false;
        }
    }
</script>
{% endblock content %}